# CommonJS 规范

## 1. 概述

之前，javascript作为后端语言，有着以下的缺陷

* 没有模块系统。
* 标准库很少，这里的标准库指的是文件系统，I/O等常见后端需求却没有标准的API。
* 没有标准接口，同样是指的后端中的web服务器，数据库操作等标准统一的接口。
* 缺乏包管理系统，这导致js应用中基本没有自动加载和安装依赖的能力。

CommonJS规范的出现，就是为了弥补JavaScript的缺陷，已达到可以像Java、Python、Ruby等具备开发大型应用的基础能力。

目前来说，js的运用已经相当广泛了，而不仅仅停留在客户端中，

* 服务器端js应用程序 (node)
* 命令行工具 (webpack,grunt,gulp..)
* 桌面图像界面应用程序(nw.js)

扩展阅读

[commonjs](http://www.commonjs.org/)

## 2. CommonJS的模块规范

commonJS定义了Module的规范，构建了一套完整的模块机制，包括

* 模块引用
* 模块定义
* 模块标识

### 2.1 模块引用

在CommonJS规范中，存在require()方法，这个方法接受模块标识，以此引入一个模块的API到当前上下文中，示例

```javascript
var math = require("math");
```

### 2.2 模块定义

在模块中，上下文提供了一个`exports`对象用于导出当前模块的方法或变量，并且它是唯一导出的出口，此外模块中还存在一个module对象，它代表模块自身，而exports是module的属性。在Node中，一个文件就是一个模块，将方法挂载在exports对象上作为属性即可定义导出的方式。

```javascript
// math.js
exports.add = function (a, b) {
    return (a+b) ;
}
```

在另外一个文件中，可以使用require来引入

```javascript
// app.js
var math = require("math");
var addResult = math.add(1, 2); // 3
```

### 2.3 模块标识

模块标识其实就是传递给require方法的参数，它可以是

* 符合驼峰式命名的字符串
* 文件路径（可以不带后缀js）

每个模块都有自己的空间，互不干扰，在应用时也显得干净利落。

## 3. Node的实现

Node借鉴了这套Modules规范，实现了一套非常易用的模块系统。在Node引入模块，需要经历如下步骤：

1. 路径分析
2. 文件定位
3. 编译执行

### 3.1 核心模块与文件模块

* 核心模块(Node提供的模块)

    核心模块部分在Node源代码编译过程中，会被编译成二进制执行文件，在Node进程启动时，部分核心模块就被直接加载到内存中，这部分模块的文件定位和编译执行可以被省略掉，并且在路径分析的时候，会优先判断，因此，这些模块的加载速度是最快的。

* 文件模块(用户自己编写的模块)

    这部分模块则是运行时动态加载，需要完整的3个步骤，即（路径分析、文件定位、编译执行），加载速度要比核心模块慢。

### 3.2 缓存加载

### 3.3 路径分析

### 3.4 文件定位

### 3.5 模块编译
